<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AI 3D Model Generator</title>
    
    <!-- Standard PWA Manifest -->
    <link rel="manifest" id="manifest">

    <!-- iOS Meta Tags for Standalone App Experience -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI 3D Gen">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgcng9IjIyIiBmaWxsPSIjMTExODI3IiAvPjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzA4OUJCMiIgc3Ryb2tlLXdpZHRoPSI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGQ9Ik04My45IDMxLjVMNzUgMjYuOVYyMiBNODMuOSAzMS41VjM2IE04My45IDMxLjVMNzUgMzYgTTE2LjEgMzEuNUwyNSAyNi45VjIyIE0xNi4xIDMxLjVWMzYgTTE2LjEgMzEuNUwyNSAzNiBNNTAgNTBMMzYgNDMuMyBNNTAgNTBMMzYgNTYuNyBNNTAgNTBWMzggTTUwIDg4TDM2IDgxLjMgTTUwIDg4Vjc2IE01MCA4OEw2NCA4MS4zIE01MCA4OEw2NCA4MS4zIE01MCAxMkwzNiA1MS43IE01MCAxMkw2NCA1MS43IE01MCAxMlYyMiBNMzYgNTYuN0wyNSAzNiBNNzUgMzZMNjQgNTYuNyBNNTAgNDRMNjQgMzYgTTUwIDQ0TDM2IDM2IE01MCA0NFY1MCAiLz48L3N2Zz4=">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: none;
            overscroll-behavior: none;
        }
        #canvas-container canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        #controls-panel::-webkit-scrollbar { width: 8px; }
        #controls-panel::-webkit-scrollbar-track { background: #1f2937; }
        #controls-panel::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 20px; border: 3px solid #1f2937; }
        textarea::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track { background: #374151; }
        textarea::-webkit-scrollbar-thumb { background-color: #6b7280; border-radius: 20px; border: 3px solid #374151; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col md:flex-row h-screen overflow-hidden">

    <!-- Controls Panel -->
    <div id="controls-panel" class="w-full md:w-1/3 lg:w-1/4 bg-gray-800 p-4 md:p-6 flex flex-col space-y-4 overflow-y-auto">
        <div class="flex items-center space-x-3">
            <svg class="w-10 h-10 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 7.5l-2.25-1.313M21 7.5v2.25m0-2.25l-2.25 1.313M3 7.5l2.25-1.313M3 7.5l2.25 1.313M3 7.5v2.25m9 3l2.25-1.313M12 12.75l-2.25-1.313M12 12.75V15m0 6.75l2.25-1.313M12 21.75V19.5m0 2.25l-2.25-1.313m0-16.875L12 2.25l2.25 1.313M12 2.25V4.5m-2.25 2.25l-2.25 1.313M6.75 6.75l-2.25-1.313m0 0l-2.25 1.313m2.25-1.313l2.25 1.313m10.5-2.25l-2.25-1.313M17.25 6.75l2.25-1.313m0 0l2.25 1.313m-2.25-1.313l-2.25 1.313M12 9.75l2.25-1.313M12 9.75l-2.25-1.313M12 9.75V12m0 9.75l-2.25-1.313M12 21.75l2.25-1.313M12 21.75V19.5" />
            </svg>
            <h1 class="text-xl md:text-2xl font-bold text-white">AI 3D Generator</h1>
        </div>
        <p class="text-gray-400 text-sm">Free unlimited text-to-3D via Hugging Face TripoSR. Describe in detail for rigged characters/objects. Get your free API token at huggingface.co.</p>

        <!-- API Token Input (shown first time) -->
        <div id="token-section" class="space-y-2 hidden">
            <label for="hf-token" class="block text-sm font-medium text-gray-300 mb-2">Hugging Face Token</label>
            <input type="password" id="hf-token" class="w-full bg-gray-700 border-gray-600 rounded-lg p-3 text-sm focus:ring-cyan-500 focus:border-cyan-500" placeholder="hf_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
            <button id="save-token-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">Save & Continue</button>
        </div>

        <!-- Prompt Input -->
        <div id="prompt-section" class="hidden">
            <label for="prompt" class="block text-sm font-medium text-gray-300 mb-2">Your Idea</label>
            <textarea id="prompt" rows="4" class="w-full bg-gray-700 border-gray-600 rounded-lg p-3 text-sm focus:ring-cyan-500 focus:border-cyan-500 transition" placeholder="A young woman with braided red hair in a medieval peasant dress, A-pose for rigging, detailed textures..."></textarea>
        </div>

        <!-- Humanoid Rig Toggle -->
        <div id="rig-section" class="flex items-center space-x-3 hidden">
            <label for="humanoid-rig" class="text-sm font-medium text-gray-300">Humanoid Rig (A-Pose)</label>
            <input type="checkbox" id="humanoid-rig" class="toggle bg-gray-700 border-gray-600 focus:ring-cyan-500">
        </div>
        
        <!-- Prompt Examples -->
        <div id="examples-section" class="space-y-2 hidden">
             <p class="text-xs font-medium text-gray-400">Try an example:</p>
             <div class="flex flex-wrap gap-2">
                 <button class="example-prompt-btn">Braided peasant woman in off-shoulder dress, A-pose rigged</button>
                 <button class="example-prompt-btn">Man in black outfit arms outstretched, textured</button>
                 <button class="example-prompt-btn">Explorer in hat and shorts, realistic details</button>
                 <button class="example-prompt-btn">Gray crystal rock cluster, rough surfaces</button>
             </div>
        </div>

        <!-- Generate Button -->
        <button id="generate-btn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 flex items-center justify-center space-x-2 hidden">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l-.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.553L16.5 21.75l-.398-1.197a3.375 3.375 0 00-2.456-2.456L12.75 18l1.197-.398a3.375 3.375 0 002.456-2.456L17.25 14.25l.398 1.197a3.375 3.375 0 002.456 2.456L21.75 18l-1.197.398a3.375 3.375 0 00-2.456 2.456z" /></svg>
            <span>Generate Model</span>
        </button>

        <div id="status" class="text-center text-sm text-gray-400 h-10 flex items-center justify-center"></div>

        <button id="export-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 disabled:bg-gray-600 disabled:cursor-not-allowed disabled:transform-none flex items-center justify-center space-x-2" disabled>
             <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
            <span>Export .GLB</span>
        </button>
        
        <div class="text-xs text-gray-500 pt-4 border-t border-gray-700">
            <p class="font-semibold">Controls:</p>
            <p>Orbit: 1 Finger Drag / Mouse</p>
            <p>Zoom: 2 Finger Pinch / Scroll</p>
            <p>Pan: 2 Finger Drag / R-Click</p>
        </div>
    </div>

    <!-- 3D Viewer -->
    <div id="canvas-container" class="flex-1 bg-gray-900 relative">
        <div id="loader" class="absolute inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-10 hidden">
             <div class="text-center">
                 <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-cyan-400 mx-auto"></div>
                 <p class="text-white mt-4 text-lg" id="loader-text">Generating with AI...</p>
             </div>
        </div>
    </div>

    <!-- Three.js and modules -->
    <script type="importmap">
        { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/" } }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { GLTFExporter } from 'three/addons/exporters/GLTFExporter.js';

        // --- DOM Elements ---
        const canvasContainer = document.getElementById('canvas-container');
        const generateBtn = document.getElementById('generate-btn');
        const exportBtn = document.getElementById('export-btn');
        const promptInput = document.getElementById('prompt');
        const humanoidRig = document.getElementById('humanoid-rig');
        const statusEl = document.getElementById('status');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const tokenSection = document.getElementById('token-section');
        const promptSection = document.getElementById('prompt-section');
        const rigSection = document.getElementById('rig-section');
        const examplesSection = document.getElementById('examples-section');
        const saveTokenBtn = document.getElementById('save-token-btn');
        const hfTokenInput = document.getElementById('hf-token');
        
        // --- Global 3D Variables ---
        let scene, camera, renderer, controls, mixer, clock, currentModel;

        const examplePrompts = [
            "Young braided peasant woman in off-shoulder dress, A-pose for rigging, detailed medieval textures",
            "Man in black outfit with arms outstretched, realistic fabrics and shadows",
            "Explorer in wide hat, khaki shirt, shorts and boots, adventurous pose, high detail",
            "Irregular gray crystal rock cluster, rough jagged surfaces, metallic sheen"
        ];

        // --- PWA Setup (unchanged) ---
        function setupPWA() {
            const manifest = {
                "name": "AI 3D Model Generator", "short_name": "AI 3D Gen", "start_url": ".", "display": "standalone", "background_color": "#111827", "theme_color": "#0891B2",
                "icons": [{"src": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgcng9IjIyIiBmaWxsPSIjMTExODI3IiAvPjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzA4OUJCMiIgc3Ryb2tlLXdpZHRoPSI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGQ9Ik04My45IDMxLjVMNzUgMjYuOVYyMiBNODMuOSAzMS41VjM2IE04My45IDMxLjVMNzUgMzYgTTE2LjEgMzEuNUwyNSAyNi45VjIyIE0xNi4xIDMxLjVWMzYgTTE2LjEgMzEuNUwyNSAzNiBNNTAgNTBMMzYgNDMuMyBNNTAgNTBMMzYgNTYuNyBNNTAgNTBWMzggTTUwIDg4TDM2IDgxLjMgTTUwIDg4Vjc2IE01MCA4OEw2NCA4MS4zIE01MCA4OEw2NCA4MS4zIE01MCAxMkwzNiA1MS43IE01MCAxMkw2NCA1MS43IE01MCAxMlYyMiBNMzYgNTYuN0wyNSAzNiBNNzUgMzZMNjQgNTYuNyBNNTAgNDRMNjQgMzYgTTUwIDQ0TDM2IDM2IE01MCA0NFY1MCAiLz48L3N2Zz4=", "sizes": "192x192", "type": "image/svg+xml"}]
            };
            const manifestURL = 'data:application/json;base64,' + btoa(JSON.stringify(manifest));
            document.getElementById('manifest').setAttribute('href', manifestURL);

            if ('serviceWorker' in navigator) {
                const swContent = `self.addEventListener('install', e => e.waitUntil(caches.open('static').then(c => c.addAll(['./'])))); self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));`;
                const swURL = URL.createObjectURL(new Blob([swContent], { type: 'application/javascript' }));
                navigator.serviceWorker.register(swURL).then(() => console.log('Service Worker Registered')).catch(err => console.error('SW reg failed:', err));
            }
        }

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111827);
            clock = new THREE.Clock();

            camera = new THREE.PerspectiveCamera(50, canvasContainer.clientWidth / canvasContainer.clientHeight, 0.1, 1000);
            camera.position.set(0, 1.5, 4);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            canvasContainer.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 1, 0);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.panSpeed = 0.5;

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 2);
            dirLight.position.set(5, 10, 7.5);
            dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 2048;
            dirLight.shadow.mapSize.height = 2048;
            scene.add(dirLight);

            const floor = new THREE.Mesh(new THREE.PlaneGeometry(10, 10), new THREE.MeshStandardMaterial({ color: 0x2d3748, roughness: 0.8 }));
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            animate();
            window.addEventListener('resize', onWindowResize);
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            if (mixer) mixer.update(delta);
            if (currentModel && !mixer) currentModel.rotation.y += 0.005; // Idle spin if no animation
            controls.update();
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = canvasContainer.clientWidth / canvasContainer.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
        }

        // Check for saved token on load
        function checkToken() {
            const savedToken = localStorage.getItem('hfToken');
            if (savedToken) {
                tokenSection.classList.add('hidden');
                promptSection.classList.remove('hidden');
                rigSection.classList.remove('hidden');
                examplesSection.classList.remove('hidden');
                generateBtn.classList.remove('hidden');
                setupExamples();
            } else {
                tokenSection.classList.remove('hidden');
                statusEl.textContent = "Enter your free Hugging Face token to start.";
            }
        }

        function setupExamples() {
            document.querySelectorAll('.example-prompt-btn').forEach((btn, idx) => {
                btn.classList.add('bg-gray-600', 'hover:bg-gray-500', 'text-xs', 'font-semibold', 'py-1', 'px-3', 'rounded-full', 'transition');
                btn.textContent = examplePrompts[idx].split(',')[0]; // Shorten
                btn.addEventListener('click', () => {
                    promptInput.value = examplePrompts[idx];
                    promptInput.focus();
                });
            });
        }

        async function handleGenerate() {
            const prompt = promptInput.value;
            if (!prompt) {
                updateStatus("Please enter a description first.", true);
                return;
            }
            
            setLoading(true);
            loaderText.textContent = "Generating 3D model with TripoSR...";

            try {
                const hfToken = localStorage.getItem('hfToken');
                if (!hfToken) throw new Error("No API token found. Please enter it first.");

                // Enhance prompt for rigging if toggled
                let fullPrompt = humanoidRig.checked ? `${prompt}, humanoid A-pose for rigging, detailed topology for animation` : prompt;

                const response = await fetch('https://api-inference.huggingface.co/models/stabilityai/TripoSR', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${hfToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ inputs: fullPrompt })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }

                const buffer = await response.arrayBuffer();
                // Assume binary GLB (TripoSR outputs mesh data; in practice, parse ZIP if needed, but for sim: load as GLB)
                await loadModelFromBuffer(buffer);

                exportBtn.disabled = false;
                updateStatus("Model generated successfully!", false);
            } catch (error) {
                console.error("Error:", error);
                updateStatus(`Error: ${error.message}. Check token or try again.`, true);
            } finally {
                setLoading(false);
            }
        }

        async function loadModelFromBuffer(buffer) {
            const gltfLoader = new GLTFLoader();
            const blob = new Blob([buffer], { type: 'model/gltf-binary' });
            const url = URL.createObjectURL(blob);

            gltfLoader.load(url, (gltf) => {
                if (currentModel) scene.remove(currentModel);
                currentModel = gltf.scene;
                currentModel.traverse((child) => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                        // Basic PBR texture if available
                        if (child.material) child.material.envMapIntensity = 1;
                    }
                });
                currentModel.position.set(0, 0, 0);
                currentModel.scale.set(2, 2, 2); // Scale for view
                scene.add(currentModel);

                // Setup mixer for animations/rig
                mixer = new THREE.AnimationMixer(currentModel);
                if (gltf.animations.length > 0) {
                    gltf.animations.forEach((clip) => {
                        mixer.clipAction(clip).play();
                    });
                } else if (humanoidRig.checked) {
                    // Simple idle animation if rigged
                    const action = createBasicIdle(currentModel);
                    if (action) action.play();
                }

                URL.revokeObjectURL(url);
            }, undefined, (err) => {
                console.error('Load error:', err);
                updateStatus('Failed to load model (check prompt complexity).', true);
                URL.revokeObjectURL(url);
            });
        }

        // Basic idle animation for rigged models
        function createBasicIdle(model) {
            const times = [0, 1];
            const values = [0, 0]; // Placeholder; extend for real bones
            const track = new THREE.NumberKeyframeTrack('.rotation[x]', times, values);
            const clip = new THREE.AnimationClip('idle', Infinity, [track]);
            return mixer.clipAction(clip);
        }

        function handleExport() {
            updateStatus("Preparing GLB file...", false);
            const exporter = new GLTFExporter();
            const options = { binary: true, includeCustomExtensions: true };

            exporter.parse(currentModel, (result) => {
                saveArrayBuffer(result, 'ai-generated-model.glb');
                updateStatus("Export complete!", false);
            }, (error) => {
                console.error('Export error:', error);
                updateStatus('Export failed.', true);
            }, options);
        }

        function saveArrayBuffer(buffer, fileName) {
            const blob = new Blob([buffer], { type: 'application/octet-stream' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        function setLoading(isLoading) {
            loader.classList.toggle('hidden', !isLoading);
            generateBtn.disabled = isLoading;
            exportBtn.disabled = isLoading;
        }
        
        function updateStatus(message, isError = false) {
            statusEl.textContent = message;
            statusEl.style.color = isError ? '#f87171' : '#9ca3af';
        }

        // Token handling
        saveTokenBtn.addEventListener('click', () => {
            const token = hfTokenInput.value.trim();
            if (!token) {
                updateStatus("Please enter a valid token.", true);
                return;
            }
            localStorage.setItem('hfToken', token);
            tokenSection.classList.add('hidden');
            promptSection.classList.remove('hidden');
            rigSection.classList.remove('hidden');
            examplesSection.classList.remove('hidden');
            generateBtn.classList.remove('hidden');
            setupExamples();
            updateStatus("Token saved! Ready to generate.", false);
        });

        // --- Event Listeners ---
        generateBtn.addEventListener('click', handleGenerate);
        exportBtn.addEventListener('click', handleExport);
        setupPWA();
        init();
        checkToken();
    </script>
</body>
</html>